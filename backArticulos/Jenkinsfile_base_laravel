import groovy.json.JsonSlurperClassic
@NonCPS
def jsonParce(def json){
    new groovy.json.JsonSlurperClassic().parseText(json)
}
pipeline{
    agent {label "master"}
    parameters{
        string(name:'tag_imagen',defaultValue:'latest',description:'etiqueta de la imagen')
    }
    environment{
        IMAGE_NAME = 'base/laravel_mysql_composer'
        AWS_REGION = 'us-east-1'
        AWS_ACCOUNT = '780989488010'
        imageName = "$(IMAGE_NAME):${tag_imagen}"
    }
    stages{
        stage ('Create Image'){
            steps{
                script{
                    REPO_NAME = "${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${imageName}"

                    sh "docker build -t ${imageName} deploy/."
                    sh "docker tag ${imageName} ${REPO_NAME}"
                }
            }
        }
        stage('Push Image'){
            steps{
                script{
                    REPO_NAME = "${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${imageName}"
                    sh "\$(aws ecr get-login --no-include-email --region ${AWS_REGION})"
                    sh "docker push ${REPO_NAME}"
                 //   sh "docker rmi -f \$(docker images ${IMAGE_NAME} -q)"
                }
            }
        }
    }
    post{
        always{
            deleteDir()
        }
    }
}
